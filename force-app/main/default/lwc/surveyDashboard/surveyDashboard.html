<template>
    <lightning-card>
        <div class="dashboard-container">

            <!-- Spinner -->
            <template if:true={isLoading}>
                <lightning-spinner alternative-text="Loading..." size="medium" variant="brand"></lightning-spinner>
            </template>

            <!-- Header -->
            <div class="dashboard-header slds-grid slds-grid_align-spread slds-m-bottom_medium">
                <h2 class="slds-text-heading_medium">My Surveys</h2>
                <lightning-button variant="brand" label="+ Create Survey" onclick={handleCreateNew}></lightning-button>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <!-- Row 1 -->
                <div class="toolbar-line">
                    <!-- Search -->
                    <div class="search">
                        <lightning-input
                            class="field"
                            type="search"
                            value={searchText}
                            placeholder="Search surveys or creators…"
                            onchange={handleSearch}>
                        </lightning-input>
                    </div>

                    <!-- Category -->
                    <lightning-combobox
                        class="field"
                        label=" "
                        value={selectedCategory}
                        options={categoryOptions}
                        onchange={handleCategoryChange}>
                    </lightning-combobox>

                    <!-- Status -->
                    <lightning-combobox
                        class="field"
                        label=" "
                        value={selectedStatus}
                        options={statusOptions}
                        onchange={handleStatusChange}>
                    </lightning-combobox>

                    <div class="flex-spacer"></div>

                    <!-- Sort (placeholder inside) -->
                    <div class="sort">
                        <lightning-combobox
                            label="Sort by"
                            variant="label-hidden"
                            placeholder="Sort by"
                            value={sortBy}
                            options={sortOptions}
                            onchange={handleSortChange}
                            class="field sort-field">
                        </lightning-combobox>
                        <lightning-button-icon
                            icon-name={sortDirIcon}
                            variant="bare"
                            size="small"
                            alternative-text="Toggle sort"
                            onclick={toggleSortDir}>
                        </lightning-button-icon>
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="toolbar-line line-2">
                    <div class="chips">
                        <template if:true={selectedCategoryLabel}>
                            <span class="chip">
                                {selectedCategoryLabel}
                                <lightning-button-icon icon-name="utility:close" size="xx-small" variant="bare" class="chip-x" onclick={clearCategory}></lightning-button-icon>
                            </span>
                        </template>
                        <template if:true={selectedStatusLabel}>
                            <span class="chip">
                                {selectedStatusLabel}
                                <lightning-button-icon icon-name="utility:close" size="xx-small" variant="bare" class="chip-x" onclick={clearStatus}></lightning-button-icon>
                            </span>
                        </template>
                        <template if:true={hasActiveFilters}>
                            <button class="chip clear" onclick={clearAll}>Clear all</button>
                        </template>
                    </div>

                    <div class="found">Found <b>{filteredCount}</b> surveys</div>
                </div>
            </div>

            <!-- Survey list -->
            <template if:true={displayed.length}>
                <template for:each={displayed} for:item="survey">
                    <div key={survey.Id} class="survey-card slds-grid slds-wrap slds-grid_align-start">

                        <!-- Icon + Title -->
                        <div class="slds-col slds-size_6-of-12 slds-grid slds-align-center icon-text-wrap">
                            <div class="survey-icon-container">
                                <svg class="custom-svg-icon" clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2"
                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="m11.6 11c0-.552-.448-1-1-1-1.655 0-4.945 0-6.6 0-.552 0-1 .448-1 1v9c0 .552.448 1 1 1h6.6c.552 0 1-.448 1-1 0-2.092 0-6.908 0-9zm9.4 6c0-.552-.448-1-1-1h-6c-.538 0-1 .477-1 1v3c0 .552.448 1 1 1h6c.552 0 1-.448 1-1zm0-13c0-.552-.448-1-1-1-1.537 0-4.463 0-6 0-.552 0-1 .448-1 1v9.6c0 .552.448 1 1 1h6c.552 0 1-.448 1-1 0-2.194 0-7.406 0-9.6zm-9.4 0c0-.552-.448-1-1-1-1.655 0-4.945 0-6.6 0-.552 0-1 .448-1 1v3.6c0 .552.448 1 1 1h6.6c.552 0 1-.448 1-1 0-1.017 0-2.583 0-3.6z"
                                        fill="#ffffff" />
                                </svg>
                            </div>
                            <div class="text-area">
                                <div class="survey-title">{survey.Survey_Name__c}</div>
                                <div class="inline-badges">
                                    <template if:true={survey.Category__c}>
                                        <span class="category-pill">{survey.Category__c}</span>
                                    </template>
                                    <span class={survey._statusClass}>{survey.Status__c}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="slds-col slds-size_3-of-12 stats-area">
                            <div class="stat-block">
                                <div class="stat-label">Created By</div>
                                <div class="stat-value">{survey._createdByName}</div>
                            </div>
                            <div class="stat-block">
                                <div class="stat-label">Created Date</div>
                                <div class="stat-value">{survey._createdDate}</div>
                            </div>
                        </div>

                        <!-- Actions: pill buttons (View · Edit · Delete) -->
                        <div class="slds-col slds-size_3-of-12 actions-area slds-align_absolute-center">
                            <button class="btn btn-outline-info"    data-id={survey.Id} onclick={handleTogglePreview}>View</button>
                            <button class="btn btn-outline-primary" data-id={survey.Id} onclick={handleEdit}>Edit</button>
                            <button class="btn btn-outline-danger"  data-id={survey.Id} onclick={openDeletePrompt}>Delete</button>
                        </div>
                    </div>
                </template>
            </template>

            <!-- Empty state -->
            <template if:true={noSurveys}>
                <div class="slds-text-align_center slds-text-body_regular slds-p-vertical_medium">
                    No surveys found.
                </div>
            </template>
        </div>

        <!-- === ADD THIS BLOCK NEAR THE END OF THE TEMPLATE (before </lightning-card> / </template>) === -->
        <template if:true={showDeletePrompt}>
            <!-- Backdrop (click to close) -->
            <div class="s360-modal-backdrop" onclick={onBackdropClick}></div>

            <!-- Lightweight modal -->
            <section role="dialog" aria-modal="true" class="s360-modal">
                <header class="s360-modal__header">
                    <h2>Delete Survey</h2>
                </header>

                <div class="s360-modal__body">
                    <p>Choose what to delete for this survey. This action cannot be undone.</p>
                    <ul class="s360-modal__list">
                        <li><strong>Delete Survey</strong> — removes the Survey, its Questions, and their Options.</li>
                        <li><strong>Delete Survey and All data related to it</strong> — also removes Responses and Answers.</li>
                    </ul>
                </div>

                <footer class="s360-modal__footer">
                    <lightning-button
                        label="Cancel"
                        variant="neutral"
                        onclick={closeDeletePrompt}
                        disabled={isDeleting}>
                    </lightning-button>

                    <lightning-button
                        label="Delete Survey"
                        variant="destructive"
                        title="Delete Survey, Questions, and Options"
                        onclick={confirmDeleteSurveyOnly}
                        disabled={isDeleting}>
                    </lightning-button>

                    <lightning-button
                        label="Delete Survey and All data related to it"
                        variant="destructive"
                        title="Delete Survey, Questions, Options, Responses, and Answers"
                        onclick={confirmDeleteAll}
                        disabled={isDeleting}>
                    </lightning-button>
                </footer>

                <template if:true={isDeleting}>
                    <div class="s360-modal__spinner">
                        <lightning-spinner alternative-text="Deleting..." size="small"></lightning-spinner>
                    </div>
                </template>
            </section>
        </template>
    </lightning-card>
</template>
